{% extends 'base.html' %}
{% block title %}Transfer Funds{% endblock %}

{% block content %}
<main class="section">
    <div class="container" style="max-width: 550px;">
        <div class="card auth-card anim-fade-in-up">
            
            <header class="auth-header">
                <div class="auth-logo"><i class="fas fa-exchange-alt"></i></div>
                <h2>Transfer Funds</h2>
                <p>Move money between your accounts or to another user.</p>
            </header>

            {% if current_user.accounts and current_user.accounts|length > 0 %}
            <form method="POST" class="auth-form" id="transferForm" novalidate>
                {{ form.hidden_tag() }}

                <!-- Transfer Type -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-sitemap"></i> Transfer Type</label>
                    <div class="segmented-control">
                        {% for subfield in form.transfer_type %}
                        <label>
                            {{ subfield() }} 
                            <span><i class="fas {{ 'fa-retweet' if subfield.data == 'internal' else 'fa-user-friends' }}"></i> {{ subfield.label.text }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- From Account -->
                <div class="form-group">
                    {{ form.from_account.label(class="form-label") }}
                    {{ form.from_account(class="form-input") }}
                    {% for error in form.from_account.errors %}<div class="form-error">{{ error }}</div>{% endfor %}
                </div>

                <!-- INTERNAL transfer fields -->
                <div id="internal-transfer-fields">
                    <div class="form-group">
                        {{ form.to_account_internal.label(class="form-label") }}
                        {{ form.to_account_internal(class="form-input") }}
                        {% for error in form.to_account_internal.errors %}<div class="form-error">{{ error }}</div>{% endfor %}
                    </div>
                </div>

                <!-- EXTERNAL transfer fields -->
                <div id="external-transfer-fields" style="display: none;">
                    <div class="form-group">
                        {{ form.recipient_account_number.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.recipient_account_number(class="form-input", placeholder="10-digit account number") }}
                            <button type="button" id="verify-btn" class="btn btn-secondary">Verify</button>
                        </div>
                        <div id="recipient-info" class="form-meta"></div>
                        {% for error in form.recipient_account_number.errors %}<div class="form-error">{{ error }}</div>{% endfor %}
                    </div>
                </div>

                <!-- Amount -->
                <div class="form-group">
                    {{ form.amount.label(class="form-label") }}
                    {{ form.amount(class="form-input", placeholder="0.00") }}
                    {% for error in form.amount.errors %}<div class="form-error">{{ error }}</div>{% endfor %}
                </div>
                
                <!-- Memo -->
                <div class="form-group">
                    {{ form.memo.label(class="form-label") }}
                    {{ form.memo(class="form-input", placeholder="(Optional) e.g., For monthly savings") }}
                    {% for error in form.memo.errors %}<div class="form-error">{{ error }}</div>{% endfor %}
                </div>

                {{ form.submit(class="btn btn-primary", style="width: 100%;") }}
            </form>
            {% else %}
            <div class="alert alert-warning">
                You need at least one account to make a transfer. Please contact support.
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- NO CHANGES NEEDED TO THIS SCRIPT ---
    // --- IT IS ALREADY WELL-STRUCTURED ---

    const transferTypeRadios = document.querySelectorAll('input[name="transfer_type"]');
    const internalFields = document.getElementById('internal-transfer-fields');
    const externalFields = document.getElementById('external-transfer-fields');
    const verifyBtn = document.getElementById('verify-btn');
    const recipientInput = document.getElementById('recipient_account_number');
    const recipientInfo = document.getElementById('recipient-info');
    const toAccountInternalInput = document.getElementById('to_account_internal');

    function toggleFields() {
        const selectedType = document.querySelector('input[name="transfer_type"]:checked').value;
        if (selectedType === 'internal') {
            internalFields.style.display = 'block';
            externalFields.style.display = 'none';
            if (recipientInput) recipientInput.required = false;
            if (toAccountInternalInput) toAccountInternalInput.required = true;
        } else {
            internalFields.style.display = 'none';
            externalFields.style.display = 'block';
            if (recipientInput) recipientInput.required = true;
            if (toAccountInternalInput) toAccountInternalInput.required = false;
        }
    }

    transferTypeRadios.forEach(radio => radio.addEventListener('change', toggleFields));
    
    if (verifyBtn) {
        verifyBtn.addEventListener('click', async () => {
            const accountNumber = recipientInput.value;
            recipientInfo.textContent = 'Verifying...';
            recipientInfo.className = 'form-meta is-verifying';
            
            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const response = await fetch('{{ url_for("verify_recipient") }}', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken 
                    },
                    body: JSON.stringify({ account_number: accountNumber })
                });
                const data = await response.json();
                if (response.ok) {
                    recipientInfo.textContent = `✓ Recipient: ${data.recipient_name}`;
                    recipientInfo.className = 'form-meta is-success';
                } else {
                    recipientInfo.textContent = `✗ ${data.error || 'Verification failed.'}`;
                    recipientInfo.className = 'form-meta is-error';
                }
            } catch (error) {
                console.error("Verification Error:", error);
                recipientInfo.textContent = '✗ Error connecting to server.';
                recipientInfo.className = 'form-meta is-error';
            }
        });
    }
    toggleFields();
});
</script>
{% endblock %}